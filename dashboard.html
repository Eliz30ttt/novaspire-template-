<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NovaBank Dashboard</title>

<style>
body { font-family: Arial; margin:0; background:#f3f4f6; }
.header { background:#1e3a8a; color:white; padding:20px; display:flex; justify-content:space-between; align-items:center; }
.card { background:white; margin:20px; padding:20px; border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.08); }
.balance { font-size:28px; font-weight:bold; color:#1e3a8a; }
.actions button { margin:5px; padding:10px 15px; border-radius:8px; border:none; cursor:pointer; }
.actions button.deposit { background:#16a34a; color:white; }
.actions button.withdraw { background:#dc2626; color:white; }
.actions button.send { background:#2563eb; color:white; }
.transactions { margin-top:20px; max-height:300px; overflow-y:auto; }
.tx { border-bottom:1px solid #ddd; padding:8px 0; display:flex; justify-content:space-between; }
.admin-link { margin:20px; display:block; color:#1e3a8a; text-decoration:none; font-weight:bold; }
</style>
</head>
<body>

<div class="header">
  <div id="welcome">Loading...</div>
  <button id="logoutBtn">Logout</button>
</div>

<div class="card">
  <h3>Account Balance</h3>
  <div class="balance" id="balance">$0.00</div>
</div>

<div class="card actions">
  <h3>Actions</h3>
  <button class="deposit" onclick="deposit()">Deposit</button>
  <button class="withdraw" onclick="withdraw()">Withdraw</button>
  <button class="send" onclick="sendMoney()">Send Money</button>
</div>

<div class="card">
  <h3>Transaction History</h3>
  <div class="transactions" id="transactions"></div>
</div>

<a href="admin.html" class="admin-link">Admin Panel</a>

<script type="module">
import { auth, db, signOut, onAuthStateChanged, doc, getDoc, updateDoc } from "./js/firebase.js";
import { collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const welcome = document.getElementById("welcome");
const balanceEl = document.getElementById("balance");
const txContainer = document.getElementById("transactions");
const logoutBtn = document.getElementById("logoutBtn");

let currentUser;
let currentData;

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }
  currentUser = user;
  welcome.innerText = "Welcome, " + user.email;
  await loadUserData();
});

// --- Load user balance and transactions ---
async function loadUserData() {
  const snap = await getDoc(doc(db,"users",currentUser.uid));
  currentData = snap.data();

  balanceEl.innerText = "$" + currentData.balance.toFixed(2);

  txContainer.innerHTML = "";
  (currentData.transactions || []).slice().reverse().forEach(tx => {
    const color = tx.type === "send" ? "#dc2626" : (tx.type==="receive"?"#16a34a":"#000");
    txContainer.innerHTML += `<div class="tx">
      <span>${tx.type.toUpperCase()}</span>
      <span style="color:${color}">$${tx.amount.toFixed(2)}</span>
    </div>`;
  });
}

// --- Deposit ---
window.deposit = async function() {
  const amount = parseFloat(prompt("Deposit amount:"));
  if(!amount || amount <= 0) return;

  currentData.balance += amount;
  addTransaction("deposit", amount);
  await save();
}

// --- Withdraw ---
window.withdraw = async function() {
  const amount = parseFloat(prompt("Withdraw amount:"));
  if(!amount || amount <= 0 || amount > currentData.balance) return alert("Insufficient balance.");

  currentData.balance -= amount;
  addTransaction("withdraw", amount);
  await save();
}

// --- Send Money ---
window.sendMoney = async function() {
  const email = prompt("Send to email:");
  const amount = parseFloat(prompt("Amount:"));
  if(!email || !amount || amount <= 0 || amount > currentData.balance) return alert("Invalid input or insufficient balance.");

  const q = query(collection(db,"users"), where("email","==",email));
  const querySnap = await getDocs(q);

  if(querySnap.empty){
    alert("User not found");
    return;
  }

  const receiverDoc = querySnap.docs[0];
  const receiverData = receiverDoc.data();
  receiverData.balance += amount;

  await updateDoc(receiverDoc.ref, {
    balance: receiverData.balance,
    transactions: [...(receiverData.transactions||[]), { type:"receive", amount, from: currentUser.email }]
  });

  currentData.balance -= amount;
  addTransaction("send", amount);
  await save();
}

// --- Add transaction locally ---
function addTransaction(type, amount) {
  if(!currentData.transactions) currentData.transactions=[];
  currentData.transactions.push({ type, amount, date: new Date() });
}

// --- Save to Firestore ---
async function save() {
  await updateDoc(doc(db,"users",currentUser.uid), {
    balance: currentData.balance,
    transactions: currentData.transactions
  });
  await loadUserData();
}

// --- Logout ---
logoutBtn.addEventListener("click", async () => {
  await signOut(auth);
  window.location.href = "login.html";
});
</script>

</body>
</html>
